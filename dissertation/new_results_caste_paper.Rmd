---
title: "New Results for Caste Paper"
date: "`r Sys.Date()`"
output:
  pdf_document:
    extra_dependencies: ["dcolumn", "booktabs", "caption", "float"]
    toc: yes
    toc_depth: 6
    keep_tex: yes
    number_sections: true
---

\captionsetup[table]{labelformat=empty}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.retina = 4)
```

```{r message=FALSE, warning=FALSE}
## Libraries
pacman::p_load(haven, estimatr, extrafont, texreg, janitor, xtable, papeR, tidyverse, compareGroups, Hmisc, skimr)
```

\newpage

```{r}
## Student Data
df_stu <- 
  read_dta(here::here("data", "stu_admin_all_latest.dta")) %>%
  left_join(read_dta(here::here("data/reservation_new.dta")), by = "stdid") %>% 
  mutate(
    reservation = dplyr::recode(reservation, "Non-reservation" = 0L, "Reservation" = 1L, .default = NA_integer_),
  )


df <- 
  read_dta(here::here("data", "all_appended.dta")) %>% 
  distinct(stdid, course_name, facid, .keep_all = T) %>% 
  left_join(
    df_stu %>% dplyr::select(stdid, classid, department_id, reservation, caste, ea_stud_group_criteria, grade),
    by = "stdid"
  ) %>%
  filter(ea_stud_group_criteria == 2, grade == 2) %>%
  left_join(read_dta(here::here("data/fac_covariates.dta")), by = "facid")


## fixing for course cleaning done by sk in sep 2021
df <-
  df %>% 
  left_join(
    read_dta(here::here("data/students_clean.dta")),
    by = c("department_id", "course_name")
  ) %>% 
  mutate(
    course_name = if_else(!is.na(course_clean_sk), course_clean_sk, course_name)
  ) %>%
  distinct(stdid, course_name, facid, .keep_all = T)
```



```{r}
## grade data after veda's work
df_grades <-
  read_dta(here::here("data/30jan2022/df_gradefac.dta")) %>% 
  filter(facid != "") %>%
  left_join(df_stu %>% dplyr::select(stdid, stu_merge, department_id, reservation, caste, b_i_jeemain_score, b_math_g1_score, b_physics_g1_score, e_math_g3_score, e_physics_g3_score, b_ct_score, b_ql_score, e_ct_score, e_ql_score, b_rr_score, e_rr_score, e_attend_grad_school, e_college_satisfied, e_dropped_out, e_switchmajor, e_math_attend = e_univtimeuse_1, e_physics_attend = e_univtimeuse_4, e_hot_attend = e_univexpr_55, e_talkprof_research, e_workprof_research, e_received_tutoring, e_growth_mindset_z), by = "stdid") %>%
  left_join(read_dta(here::here("data/controls.dta")), by = "stdid") %>%
  left_join(read_dta(here::here("data/fac_covariates.dta")), by = "facid") %>% 
  arrange(department_id, course_name, course_grade_clean) %>% 
  group_by(department_id, course_name) %>% 
  mutate(
    course_rank = (scale(course_grade_clean) %>% pnorm() * 100) %>% as.vector
  ) %>% 
  ungroup() %>%
  mutate(
    father_college = if_else(father_ed_ind > 3 & !is.na(father_ed_ind), 1L, 0L),
    father_college = if_else(is.na(father_ed_ind), NA_integer_, father_college),
    mother_college = if_else(mother_ed_ind > 3 & !is.na(mother_ed_ind), 1L, 0L),
    mother_college = if_else(is.na(mother_ed_ind), NA_integer_, mother_college),
    ses = ses %>% as.integer(),
  ) %>%
  relocate(department_id, course_name, stdid, course_rank) %>% 
  rename(reservation_stu = reservation, semester = semester_clean)

department_ids <- df_grades %>% distinct(department_id) %>% pull(department_id)
univcodes <- df_grades %>% distinct(univcode) %>% pull(univcode)

# filtering to all faculty surveyed during the endline phase who were also mentioned by students
facdata_mentions <-
  read_dta(here::here("data/all_appended.dta")) %>%
  filter(tag > 1) %>%  # endline only
  left_join(df_stu %>% select(stdid, department_id), by = "stdid") %>%  # get dep_id
  select(facid, department_id) %>% 
  count(facid, department_id) %>% 
  arrange(facid, desc(n)) %>% 
  distinct(facid, .keep_all = T) %>% 
  select(-n) %>% 
  left_join(read_dta(here::here("data/endline_faculty_data_final.dta")), by = "facid")

rm(df)
```


```{r, eval=F}
df_grades %>% 
  arrange(stdid) %>% 
  mutate(n = 1) %>% 
  filter(subject == "physics") %>%
  group_by(stdid) %>% 
  summarise(n = sum(n, na.rm = T)) %>% 
  skim(n)
```


# Long term outcomes

## Math and Physics tests

These regressions are using only math/physics courses only. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r}
df_math <-
  df_grades %>%
  filter(subject == "math") %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_math_g3_score) %>%
  group_by(stdid, subject, reservation_stu, female, father_college, mother_college, b_math_g1_score, e_math_g3_score, age, miss_age, department_id) %>%
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(
    e_g3_score = scale(e_math_g3_score) %>% as.vector,
    b_g1_score = scale(b_math_g1_score) %>% as.vector,
    # limits
    e_g3_score = if_else(e_g3_score > 3, 3, e_g3_score),
    e_g3_score = if_else(e_g3_score < -3, -3, e_g3_score),
    b_g1_score = if_else(b_g1_score > 3, 3, b_g1_score),
    b_g1_score = if_else(b_g1_score < -3, -3, b_g1_score),
  ) %>% 
  relocate(stdid, subject, reservation_fac, e_g3_score, b_g1_score, e_math_g3_score, b_math_g1_score)

df_physics <-
  df_grades %>%
  filter(subject == "physics") %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_physics_g3_score) %>%
  group_by(stdid, subject, reservation_stu, female, father_college, mother_college, b_physics_g1_score, e_physics_g3_score, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>%
  ungroup() %>% 
  mutate(
    e_g3_score = scale(e_physics_g3_score) %>% as.vector,
    b_g1_score = scale(b_physics_g1_score) %>% as.vector,
    # limits
    e_g3_score = if_else(e_g3_score > 3, 3, e_g3_score),
    e_g3_score = if_else(e_g3_score < -3, -3, e_g3_score),
    b_g1_score = if_else(b_g1_score > 3, 3, b_g1_score),
    b_g1_score = if_else(b_g1_score < -3, -3, b_g1_score),
  ) %>% 
  relocate(stdid, subject, reservation_fac, e_g3_score, b_g1_score, e_physics_g3_score, b_physics_g1_score)

df_temp <-
  bind_rows(df_math, df_physics) %>% 
  arrange(stdid, subject) %>% 
  relocate(stdid, subject) %>%
  mutate(subject = as_factor(str_to_title(subject)))
```


The dependent variables are standardized test scores (mean 0). All models include baseline score controls and department fixed effects.

**Math only:**

```{r, results='asis'}
lm1 <-
  df_math %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac + b_g1_score, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_math %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac + b_g1_score + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_math %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac + b_g1_score + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_math %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac * reservation_stu + b_g1_score + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

Outcome and treatment distribution for Math:

```{r}
df_temp %>%
  filter(subject == "Math") %>% 
  drop_na(female, father_college, mother_college) %>% 
  dplyr::select(reservation_fac, e_g3_score_math = e_g3_score) %>%
  pivot_longer(cols = c(reservation_fac, e_g3_score_math)) %>% 
  ggplot(aes(value)) +
  geom_histogram(bins = 16) +
  facet_wrap(vars(name), scales = "free") +
  theme_minimal() +
  labs(x = "")
```

\newpage

**Physics only:**

```{r, results='asis'}
lm1 <-
  df_physics %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac + b_g1_score, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_physics %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac + b_g1_score + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_physics %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac + b_g1_score + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_physics %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_g3_score ~ reservation_fac * reservation_stu + b_g1_score + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

Outcome and treatment distribution for Physics:

```{r}
df_temp %>%
  filter(subject == "Physics") %>% 
  drop_na(female, father_college, mother_college) %>% 
  dplyr::select(reservation_fac, e_g3_score_physics = e_g3_score) %>% 
  pivot_longer(cols = c(reservation_fac, e_g3_score_physics)) %>% 
  ggplot(aes(value)) +
  geom_histogram(bins = 16) +
  facet_wrap(vars(name), scales = "free") +
  theme_minimal() +
  labs(x = "")
```


\newpage

## HOT tests

These regressions are using all courses with grades (_not_ restricted to math/physics only). Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r}
df_ct <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_ct_score) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, b_ct_score, e_ct_score, b_rr_score, e_rr_score, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(
    e_ct_score = scale(e_ct_score) %>% as.vector,
    b_ct_score = scale(b_ct_score) %>% as.vector,
    e_rr_score = scale(e_rr_score) %>% as.vector,
    b_rr_score = scale(b_rr_score) %>% as.vector,
    # limits
    e_ct_score = if_else(e_ct_score > 3, 3, e_ct_score),
    e_ct_score = if_else(e_ct_score < -3, -3, e_ct_score),
    b_ct_score = if_else(b_ct_score > 3, 3, b_ct_score),
    b_ct_score = if_else(b_ct_score < -3, -3, b_ct_score),
    # limits
    e_rr_score = if_else(e_rr_score > 3, 3, e_rr_score),
    e_rr_score = if_else(e_rr_score < -3, -3, e_rr_score),
    b_rr_score = if_else(b_rr_score > 3, 3, b_rr_score),
    b_rr_score = if_else(b_rr_score < -3, -3, b_rr_score),
  ) %>%
  pivot_longer(cols = c(e_ct_score, e_rr_score, b_ct_score, b_rr_score)) %>% 
  mutate(
    subject = str_sub(name, 3, 4) %>% str_to_upper(),
    name = if_else(str_detect(name, "^b_"), "b_score", "e_score"),
  ) %>% 
  pivot_wider(names_from = name, values_from = value) %>% 
  mutate(testtype = "CT-RR") %>% 
  relocate(stdid, subject, e_score, b_score, testtype)

df_ql <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_ql_score) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, b_ql_score, e_ql_score, b_rr_score, e_rr_score, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(
    e_ql_score = scale(e_ql_score) %>% as.vector,
    b_ql_score = scale(b_ql_score) %>% as.vector,
    e_rr_score = scale(e_rr_score) %>% as.vector,
    b_rr_score = scale(b_rr_score) %>% as.vector,
    # limits
    e_ql_score = if_else(e_ql_score > 3, 3, e_ql_score),
    e_ql_score = if_else(e_ql_score < -3, -3, e_ql_score),
    b_ql_score = if_else(b_ql_score > 3, 3, b_ql_score),
    b_ql_score = if_else(b_ql_score < -3, -3, b_ql_score),
    # limits
    e_rr_score = if_else(e_rr_score > 3, 3, e_rr_score),
    e_rr_score = if_else(e_rr_score < -3, -3, e_rr_score),
    b_rr_score = if_else(b_rr_score > 3, 3, b_rr_score),
    b_rr_score = if_else(b_rr_score < -3, -3, b_rr_score),
  ) %>%
  pivot_longer(cols = c(e_ql_score, e_rr_score, b_ql_score, b_rr_score)) %>% 
  mutate(
    subject = str_sub(name, 3, 4) %>% str_to_upper(),
    name = if_else(str_detect(name, "^b_"), "b_score", "e_score")
  ) %>% 
  pivot_wider(names_from = name, values_from = value) %>% 
  mutate(testtype = "QL-RR") %>% 
  relocate(stdid, subject, e_score, b_score, testtype)

df_temp <-
  bind_rows(df_ct, df_ql) %>% 
  arrange(stdid, subject) %>% 
  mutate(subject = fct_infreq(subject)) %>% 
  relocate(department_id, stdid, subject, e_score, b_score, testtype, reservation_fac, contains("fac_")) %>% 
  mutate(
    ct_dummy = if_else(subject == "CT", 1L, 0L),
    ql_dummy = if_else(subject == "QL", 1L, 0L),
    b_score_ct = b_score * ct_dummy,
    b_score_ql = b_score * ql_dummy,
  )

rm(df_ct, df_ql)
```


The dependent variables are standardized test scores (mean 0). All models include baseline score controls and department fixed effects.

```{r, results='asis'}
lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_score ~ reservation_fac + subject + testtype + b_score + b_score_ct + b_score_ql, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_score ~ reservation_fac + subject + testtype + b_score + b_score_ct + b_score_ql + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_score ~ reservation_fac + subject + testtype + b_score + b_score_ct + b_score_ql + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_score ~ reservation_fac * reservation_stu + subject + testtype + b_score + b_score_ct + b_score_ql + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)


knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

## Hours attending classes

The dependent variable is average daily hours attending classes (0-15) for HOT (all subjects), for math, or for physics. Mean of this variable is 6.17. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r}
df_math <-
  df_grades %>%
  filter(subject == "math") %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  rename(e_attend = e_math_attend) %>% 
  drop_na(e_attend) %>%
  group_by(stdid, subject, reservation_stu, female, father_college, mother_college, e_attend, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  relocate(stdid, reservation_fac, e_attend)

df_physics <-
  df_grades %>%
  filter(subject == "physics") %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  rename(e_attend = e_physics_attend) %>% 
  drop_na(e_attend) %>%
  group_by(stdid, subject, reservation_stu, female, father_college, mother_college, e_attend, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  relocate(stdid, reservation_fac, e_attend)

df_hot <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  rename(e_attend = e_hot_attend) %>%
  drop_na(e_attend) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, e_attend, age, miss_age, department_id) %>%
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>%
  mutate(subject = "HOT") %>% 
  relocate(stdid, reservation_fac, e_attend, subject)


df_temp <-
  bind_rows(df_math, df_physics, df_hot) %>% 
  arrange(stdid, subject) %>% 
  relocate(stdid, subject) %>% 
  mutate(subject = as_factor(str_to_title(subject)) %>% fct_relevel(sort))

rm(df_math, df_physics, df_hot)
```


All models include department fixed effects.

```{r, results='asis'}
lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend ~ reservation_fac + subject, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend ~ reservation_fac + subject + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend ~ reservation_fac + subject + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend ~ reservation_fac * reservation_stu + subject + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

## College satisfaction

The dependent variable is college satisfaction (0/1). Mean is 0.70. All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_college_satisfied, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage

## Plans for grad school

The dependent variable is plans for grad school (0/1). Mean is 0.61. All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_attend_grad_school, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

## College dropout

The dependent variable is college dropout (0/1). Mean is 0.01. All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

### Crosstabs of control variables with dropout status

```{r}
df_temp <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_dropped_out, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()
```

```{r}
df_temp %>% tabyl(reservation_stu, e_dropped_out, show_na = F) %>% knitr::kable(booktabs = T)
```

```{r}
df_temp %>% tabyl(female, e_dropped_out, show_na = F) %>% knitr::kable(booktabs = T)
```

```{r}
df_temp %>% tabyl(father_college, e_dropped_out, show_na = F) %>% knitr::kable(booktabs = T)
```

```{r}
df_temp %>% tabyl(mother_college, e_dropped_out, show_na = F) %>% knitr::kable(booktabs = T)
```


### Probit model with marginal effects

```{r, results='asis'}
lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(e_dropped_out ~ reservation_fac + department_id, data = ., robust = T)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(e_dropped_out ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + department_id, data = ., robust = T)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(e_dropped_out ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female + department_id, data = ., robust = T)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(e_dropped_out ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female + department_id, data = ., robust = T)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 6, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)|(department_id)")
```


\newpage


## Switch major

The dependent variable is switching major (0/1). Mean is 0 (i.e., no sampled student switches major). All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_switchmajor, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage



## Closed or open mindset

The dependent variable growth mindset is created by applying the Anderson index to 3 survey items on intelligence beliefs across the national sample. This variable is then turned into a z-score before use in below regression models. Mean is -0.1 (should I standardize within our 12 college sample?). Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_grades %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_growth_mindset_z, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage

## Receiving Tutoring

### Old results (HOT + Math)

Dependent variable is receiving paid or unpaid tutoring (0/1). Mean is 0.736. We combine data from HOT and Math surveys and use survey type as a control in the regression models. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r}
df_math <-
  df_grades %>%
  filter(subject == "math") %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_math_g3_score, e_received_tutoring) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, e_received_tutoring, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(survey = "math") %>%
  relocate(stdid, reservation_fac, e_received_tutoring)

df_hot <-
  df_grades %>%
  filter(!(is.na(e_ct_score) & is.na(e_ql_score))) %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_received_tutoring) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, e_received_tutoring, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(survey = "hot") %>%
  relocate(stdid, reservation_fac, e_received_tutoring)

df_temp <-
  bind_rows(df_math, df_hot) %>% 
  arrange(stdid, survey) %>% 
  relocate(stdid, survey) %>% 
  mutate(survey = as_factor(str_to_title(survey)))

rm(df_math, df_hot)
```


All models include department fixed effects.

```{r, results='asis'}
lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac + survey, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac + survey + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac + survey + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac * reservation_stu + survey + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage

### New results (HOT only)

Dependent variable is receiving paid or unpaid tutoring (0/1). Mean is 0.72. We use data from HOT survey only in the regression models. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r}
df_temp <-
  df_grades %>%
  filter(!(is.na(e_ct_score) & is.na(e_ql_score))) %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_received_tutoring) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, e_received_tutoring, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(survey = "hot") %>%
  relocate(stdid, reservation_fac, e_received_tutoring)
```

All models include department fixed effects.

```{r, results='asis'}
lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_received_tutoring ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage

## Working with faculty on research

Dependent variable is working with faculty on their research (0/1). Mean is 0.21. We combine data from HOT and Math surveys and use survey type as a control in the regression models. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r}
df_math <-
  df_grades %>%
  filter(subject == "math") %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_math_g3_score, e_workprof_research) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, e_workprof_research, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(survey = "math") %>%
  relocate(stdid, reservation_fac, e_workprof_research)

df_hot <-
  df_grades %>%
  filter(!(is.na(e_ct_score) & is.na(e_ql_score))) %>% 
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>% 
  drop_na(e_workprof_research) %>%
  group_by(stdid, reservation_stu, female, father_college, mother_college, e_workprof_research, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T) * 10,
    fac_associate_professor = mean(fac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(fac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(fac_female, na.rm = T) * 10,
  ) %>% 
  ungroup() %>% 
  mutate(survey = "hot") %>%
  relocate(stdid, reservation_fac, e_workprof_research)

df_temp <-
  bind_rows(df_math, df_hot) %>% 
  arrange(stdid, survey) %>% 
  relocate(stdid, survey) %>% 
  mutate(survey = as_factor(str_to_title(survey)))

rm(df_math, df_hot)
```


All models include department fixed effects.

```{r, results='asis'}
lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_workprof_research ~ reservation_fac + survey, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_workprof_research ~ reservation_fac + survey + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_workprof_research ~ reservation_fac + survey + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_workprof_research ~ reservation_fac * reservation_stu + survey + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```



\newpage

# Robustness checks

## New balance table

Baselint test scores (Math and Physics) are standardized to have a mean 0 and and sd 1.

```{=latex}
\begin{table}[H]
  \centering
  \begin{tabular}{@{}lllllll@{}}
    \toprule
    \multicolumn{1}{c}{}  &  & \multicolumn{5}{c}{Panel A: Faculty}  \\ \cmidrule(l){3-7}
                                      &           &               &             &           &                             &             \\
    \textbf{Faculty characteristics}  & \textbf{} & \textbf{Mean} & \textbf{SD} & \textbf{} & \textbf{Res-NonRes faculty} & \textbf{SE} \\
                                      &           &               &             &           &                             &             \\
    Reservation status                &           & 0.39          & 0.49        &           & 1.000                       &             \\
    Assistant Professor               &           & 0.72          & 0.45        &           & 0.055                       & 0.061       \\
    Associate Professor               &           & 0.18          & 0.38        &           & 0.018                       & 0.043       \\
    Professor                         &           & 0.08          & 0.27        &           & -0.071                      & 0.043       \\
    Experience in years               &           & 9.96          & 6.51        &           & -1.391*                     & 0.793       \\
    Highest degree is Masters         &           & 0.51          & 0.50        &           & 0.147**                     & 0.074       \\
    Highest degree is PhD             &           & 0.32          & 0.47        &           & -0.133***                   & 0.041       \\
    Highest degree is PhD in progress &           & 0.15          & 0.36        &           & -0.023                      & 0.068       \\
    Degree college elite              &           & 0.32          & 0.47        &           & -0.109*                     & 0.063       \\
    Female                            &           & 0.33          & 0.47        &           & -0.008                      & 0.076       \\
                                      &           &               &             &           &                             &             \\ \cmidrule(l){3-7}
    &  & \multicolumn{5}{c}{Panel B: Students} \\ \cmidrule(l){3-7}
                                      &           &               &             &           &                             &             \\
    \textbf{Student characteristics}  & \textbf{} & \textbf{Mean} & \textbf{SD} & \textbf{} & \textbf{Res-NonRes faculty} & \textbf{SE} \\
                                      &           &               &             &           &                             &             \\
    Reservation status                &           & 0.54          & 0.50        &           & -0.008                      & 0.010       \\
    Female                            &           & 0.44          & 0.50        &           & -0.002                      & 0.007       \\
    Age                               &           & 17.72         & 0.80        &           & 0.001                       & 0.011       \\
    Father college                    &           & 0.50          & 0.50        &           & 0.005                       & 0.010       \\
    Mother college                    &           & 0.35          & 0.48        &           & 0.018**                     & 0.008       \\ 
    Baseline Math score               &           & 0.00          & 1.00        &           & 0.001                       & 0.024       \\
    Baseline Physics score            &           & 0.00          & 1.00        &           & -0.010                      & 0.025       \\
  % Baseline HOT score                &           & 0.00          & 1.00        &           & 0.069***                    & 0.022       \\
    JEE Main score                    &           & 68.14         & 44.33       &           & 0.971                       & 0.920       \\
    Took JEE Main                     &           & 0.67          & 0.47        &           & 0.004                       & 0.008       \\ \bottomrule
  \end{tabular}
\end{table}
```

\newpage

## Semester and Introductory Courses

```{r}
# loading raw data
df_all_raw <-
  bind_rows(
  read_dta("/Users/saurabh/Everything/Supertest/Data/India/Endline/Students/working_data/course_fac/random/New work - 6 Jan 2020/piyali_grade_data/2 courses for piyali/b_mp.dta"),
  read_dta("/Users/saurabh/Everything/Supertest/Data/India/Endline/Students/working_data/course_fac/random/New work - 6 Jan 2020/piyali_grade_data/2 courses for piyali/b_nonmp.dta"),
  read_dta("/Users/saurabh/Everything/Supertest/Data/India/Endline/Students/working_data/course_fac/random/New work - 6 Jan 2020/piyali_grade_data/2 courses for piyali/e_mp.dta"),
  read_dta("/Users/saurabh/Everything/Supertest/Data/India/Endline/Students/working_data/course_fac/random/New work - 6 Jan 2020/piyali_grade_data/2 courses for piyali/e_nonmp.dta"),
  .id = "tag"
  ) %>% 
  mutate(tag = as.integer(tag) - 1L) %>%
  filter(facid != "") %>% 
  select(tag, stdid, course_name, facid, semester) %>% 
  left_join(df_stu %>% select(stdid, department_id, grade), by = "stdid") %>% 
  left_join(read_dta("/Users/saurabh/Everything/Supertest/Data/India/Endline/Students/working_data/course_fac/random/New work - 6 Jan 2020/piyali_grade_data/3 final merging for prashant/res_fac_all.dta"), by = "facid")
```


**Panel A: 50-college sample for Year 1/2 cohort**

Aggregated using department-level weights.

```{r, results='asis'}
df_all_raw %>%
  filter(grade == 2, semester <= 4) %>%
  drop_na(reservation_fac) %>% 
  left_join(read_csv("/Users/saurabh/Everything/GitHub/teacher-like-me/data/depweights.csv"), by = "department_id") %>% 
  group_by(semester) %>% 
  summarise(
    n = sum(n()),
    reservation = round(weighted.mean(reservation_fac, w = sw_f, na.rm = T) * 100, 2)
  ) %>% 
  mutate(
    non_reservation = (100 - reservation) %>% str_c("%"),
    reservation = reservation %>% str_c("%")
  ) %>% 
  clean_names(case = "title") %>% 
  select(-N) %>%
  mutate(Semester = as.character(Semester)) %>% 
  add_row(
    df_all_raw %>%
      filter(grade == 2, semester <= 4) %>%
      count(reservation_fac) %>% 
      drop_na() %>% 
      pivot_wider(names_from = reservation_fac, values_from = n) %>% 
      mutate(Semester = "N") %>% 
      select(Semester, `Reservation` = `1`, `Non Reservation` = `0`) %>% 
      mutate_all(as.character)
  ) %>% 
  knitr::kable(booktabs = T)
```


**Panel B: 12-college sample for Year 1/2 cohort with grades**

```{r, results='asis'}
df_grades %>%
  tabyl(semester, reservation_fac, show_na = F) %>% 
  as_tibble() %>% 
  rename(non_reservation = `0`, reservation = `1`) %>% 
  transmute(
    Semester = semester %>% as.character(),
    N = reservation + non_reservation,
    `Reservation category` = round(reservation/N * 100, 2) %>% str_c("%"),
    `Non-reservation category` = round(non_reservation/N * 100, 2) %>% str_c("%")
  ) %>% 
  select(-N) %>% 
  add_row(
    df_grades %>% 
      count(reservation_fac) %>% 
      drop_na() %>% 
      pivot_wider(names_from = reservation_fac, values_from = n) %>% 
      mutate(Semester = "N") %>% 
      select(Semester, `Reservation category` = `1`, `Non-reservation category` = `0`) %>% 
      mutate_all(as.character)
  ) %>% 
  knitr::kable(booktabs = T)
```


```{r, results='asis'}
df_grades %>% 
  inner_join(readxl::read_xlsx(here::here("data/introductory_courses.xlsx")), by = "course_name") %>%
  tabyl(introductory, reservation_fac, show_na = F) %>% 
  as_tibble() %>% 
  arrange(desc(introductory)) %>% 
  rename(non_reservation = `0`, reservation = `1`) %>% 
  transmute(
    Introductory = introductory %>% as.character(),
    N = reservation + non_reservation,
    `Reservation category` = round(reservation/N * 100, 2) %>% str_c("%"),
    `Non-reservation category` = round(non_reservation/N * 100, 2) %>% str_c("%")
  ) %>% 
  select(-N) %>% 
  add_row(
    df_grades %>% 
      count(reservation_fac) %>% 
      drop_na() %>% 
      pivot_wider(names_from = reservation_fac, values_from = n) %>% 
      mutate(Introductory = "N") %>% 
      select(Introductory, `Reservation category` = `1`, `Non-reservation category` = `0`) %>% 
      mutate_all(as.character)
  ) %>% 
  knitr::kable(booktabs = T)
```

**Panel C: 50-college sample for Year 3/4 cohort**

Aggregated using department-level weights.

```{r, results='asis'}
bind_rows(
  df_all_raw %>% filter(grade == 4, tag %in% c(0, 1), semester <= 4), # first 2 years from baseline
  df_all_raw %>% filter(grade == 4, tag %in% c(2, 3), semester >= 5) # last 2 years from endline
) %>% 
  mutate(
    year = case_when(
      semester %in% c(1, 2) ~ 1L,
      semester %in% c(3, 4) ~ 2L,
      semester %in% c(5, 6) ~ 3L,
      semester %in% c(7, 8) ~ 4L,
      TRUE ~ NA_integer_
    )
  ) %>% 
  drop_na(reservation_fac) %>% 
  left_join(read_csv("/Users/saurabh/Everything/GitHub/teacher-like-me/data/depweights.csv"), by = "department_id") %>% 
  group_by(year) %>% 
  summarise(
    n = sum(n()),
    reservation = round(weighted.mean(reservation_fac, w = sw_f, na.rm = T) * 100, 2)
  ) %>% 
  mutate(
    non_reservation = (100 - reservation) %>% str_c("%"),
    reservation = reservation %>% str_c("%")
  ) %>% 
  clean_names(case = "title") %>%
  select(-N) %>% 
  mutate(Year = as.character(Year)) %>% 
  add_row(
    bind_rows(
      df_all_raw %>% filter(grade == 4, tag %in% c(0, 1), semester <= 4), # first 2 years from baseline
      df_all_raw %>% filter(grade == 4, tag %in% c(2, 3), semester >= 5) # last 2 years from endline
    ) %>%
      count(reservation_fac) %>% 
      drop_na() %>% 
      pivot_wider(names_from = reservation_fac, values_from = n) %>% 
      mutate(Year = "N") %>% 
      select(Year, `Reservation` = `1`, `Non Reservation` = `0`) %>% 
      mutate_all(as.character)
  ) %>% 
  knitr::kable(booktabs = T)
```

\newpage


## Main results without student controls/fixed effects

### Version 1

The dependent variable is the student course grade. Grades are provided at the course level and not the faculty level. Standard errors are clustered at faculty level.

```{=latex}
\begin{table}[H]
\begin{center}
\begin{tabular}{l D{.}{.}{5.5} D{.}{.}{5.5} D{.}{.}{5.4}}
\toprule
 & \multicolumn{1}{c}{I} & \multicolumn{1}{c}{II} & \multicolumn{1}{c}{III} \\
\midrule
reservation\_fac                    & 1.22^{*}   & 1.20^{*}     & 1.34^{**}  \\
                                    & (0.64)     & (0.64)       & (0.56)     \\
fac\_associate\_professor           & 1.02       & 1.07         & 1.27       \\
                                    & (0.88)     & (0.89)       & (0.82)     \\
fac\_professor                      & 4.03^{***} & 4.04^{***}   & 3.18^{**}  \\
                                    & (1.38)     & (1.46)       & (1.32)     \\
fac\_yearsinhighed                  & 0.00       & 0.02         & -0.01      \\
                                    & (0.06)     & (0.06)       & (0.05)     \\
fac\_highest\_degree\_phd           & -2.94^{**} & -3.29^{***}  & -2.55^{**} \\
                                    & (1.18)     & (1.21)       & (1.17)     \\
fac\_highest\_degree\_phd\_in\_prog & -0.31      & -0.52        & -0.94      \\
                                    & (1.01)     & (1.03)       & (0.82)     \\
fac\_degree\_college\_elite         & 0.06       & 0.10         & 0.31       \\
                                    & (0.72)     & (0.71)       & (0.59)     \\
fac\_female                         & 1.40^{**}  & 1.47^{**}    & 1.09^{*}   \\
                                    & (0.63)     & (0.63)       & (0.57)     \\
reservation\_stu                    &            & -4.97^{***}  &            \\
                                    &            & (0.46)       &            \\
female                              &            & 11.64^{***}  &            \\
                                    &            & (0.66)       &            \\
age                                 &            & -0.27        &            \\
                                    &            & (0.23)       &            \\
father\_college                     &            & 1.14^{***}   &            \\
                                    &            & (0.39)       &            \\
mother\_college                     &            & 0.16         &            \\
                                    &            & (0.38)       &            \\
miss\_reservation\_stu              &            & 3.60         &            \\
                                    &            & (5.25)       &            \\
miss\_female                        &            & -13.81^{***} &            \\
                                    &            & (3.51)       &            \\
miss\_age                           &            & -11.71^{***} &            \\
                                    &            & (4.26)       &            \\
miss\_father\_college               &            & -0.75        &            \\
                                    &            & (2.96)       &            \\
miss\_mother\_college               &            & -16.33^{***} &            \\
                                    &            & (3.58)       &            \\
\midrule
Num. obs.                           & 37716      & 37716        & 37716      \\
\bottomrule
\multicolumn{4}{l}{\scriptsize{$^{***}p<0.01$; $^{**}p<0.05$; $^{*}p<0.1$}}
\end{tabular}
\caption{}
\label{}
\end{center}
\end{table}
```


\newpage


### Version 2

```{=latex}
\begin{table}[H]
\begin{center}
\begin{tabular}{l D{.}{.}{5.5} D{.}{.}{5.5} D{.}{.}{5.4}}
\toprule
 & \multicolumn{1}{c}{I} & \multicolumn{1}{c}{II} & \multicolumn{1}{c}{III} \\
\midrule
reservation\_fac                    & 0.63         & 0.75         & 1.49^{**}  \\
                                    & (0.77)       & (0.78)       & (0.64)     \\
reservation\_stu                    & -6.08^{***}  & -5.30^{***}  &            \\
                                    & (0.57)       & (0.60)       &            \\
reservation\_fac:reservation\_stu   & 0.96         & 0.83         & -0.29      \\
                                    & (0.87)       & (0.92)       & (0.66)     \\
fac\_associate\_professor           & 0.98         & 1.08         & 1.27       \\
                                    & (0.89)       & (0.89)       & (0.82)     \\
fac\_professor                      & 3.99^{***}   & 4.05^{***}   & 3.17^{**}  \\
                                    & (1.39)       & (1.46)       & (1.32)     \\
fac\_yearsinhighed                  & 0.00         & 0.02         & -0.01      \\
                                    & (0.06)       & (0.06)       & (0.05)     \\
fac\_highest\_degree\_phd           & -3.06^{***}  & -3.30^{***}  & -2.55^{**} \\
                                    & (1.18)       & (1.20)       & (1.17)     \\
fac\_highest\_degree\_phd\_in\_prog & -0.45        & -0.52        & -0.94      \\
                                    & (1.02)       & (1.03)       & (0.82)     \\
fac\_degree\_college\_elite         & 0.03         & 0.10         & 0.31       \\
                                    & (0.72)       & (0.71)       & (0.59)     \\
fac\_female                         & 1.50^{**}    & 1.46^{**}    & 1.09^{*}   \\
                                    & (0.62)       & (0.63)       & (0.57)     \\
miss\_reservation\_stu              & -13.40^{***} & 3.55         &            \\
                                    & (4.76)       & (5.25)       &            \\
female                              &              & 11.63^{***}  &            \\
                                    &              & (0.66)       &            \\
age                                 &              & -0.27        &            \\
                                    &              & (0.23)       &            \\
father\_college                     &              & 1.14^{***}   &            \\
                                    &              & (0.39)       &            \\
mother\_college                     &              & 0.14         &            \\
                                    &              & (0.38)       &            \\
miss\_female                        &              & -13.81^{***} &            \\
                                    &              & (3.52)       &            \\
miss\_age                           &              & -11.67^{***} &            \\
                                    &              & (4.26)       &            \\
miss\_father\_college               &              & -0.77        &            \\
                                    &              & (2.96)       &            \\
miss\_mother\_college               &              & -16.31^{***} &            \\
                                    &              & (3.58)       &            \\
\midrule
Num. obs.                           & 37716        & 37716        & 37716      \\
\bottomrule
\multicolumn{4}{l}{\scriptsize{$^{***}p<0.01$; $^{**}p<0.05$; $^{*}p<0.1$}}
\end{tabular}
\caption{}
\label{}
\end{center}
\end{table}
```


\newpage

## Follow-on Courses

### Semester based

```{r}
df_sem1 <-
  df_grades %>% 
  filter(semester == 1) %>% 
  group_by(stdid) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T),
    fac_associate_professor = mean(fac_associate_professor, na.rm = T),
    fac_professor = mean(fac_professor, na.rm = T),
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T),
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T),
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T),
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T),
    fac_female = mean(fac_female, na.rm = T),
  ) %>%
  ungroup() %>% 
  mutate(semester_past = 1)

df_sem2 <-
  df_grades %>% 
  filter(semester == 2) %>% 
  group_by(stdid) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T),
    fac_associate_professor = mean(fac_associate_professor, na.rm = T),
    fac_professor = mean(fac_professor, na.rm = T),
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T),
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T),
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T),
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T),
    fac_female = mean(fac_female, na.rm = T),
  ) %>%
  ungroup() %>% 
  mutate(semester_past = 2)

df_sem3 <-
  df_grades %>% 
  filter(semester == 3) %>% 
  group_by(stdid) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T),
    fac_associate_professor = mean(fac_associate_professor, na.rm = T),
    fac_professor = mean(fac_professor, na.rm = T),
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T),
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T),
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T),
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T),
    fac_female = mean(fac_female, na.rm = T),
  ) %>%
  ungroup() %>% 
  mutate(semester_past = 3)

df_temp <-
  bind_rows(
    df_grades %>% filter(semester == 2) %>% select(-contains(c("fac_", "_fac"))) %>% inner_join(df_sem1, ., by = "stdid"),
    df_grades %>% filter(semester == 3) %>% select(-contains(c("fac_", "_fac"))) %>% inner_join(df_sem2, ., by = "stdid"),
    df_grades %>% filter(semester == 4) %>% select(-contains(c("fac_", "_fac"))) %>% inner_join(df_sem3, ., by = "stdid")
  ) %>% 
  arrange(stdid, semester, course_name) %>% 
  relocate(stdid, semester, semester_past) %>% 
  mutate(semester = as_factor(semester))
```


Dependent variable mean is 51.84 and SD is 27.81. All models include course fixed effects and student fixed effects. SEs clustered at faculty level. Faculty treatment and controls are _not_ multiplied by 10 here.


```{r, results='asis'}
lm1a <-
  df_temp %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm2a <-
  df_temp %>% 
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac + fac_associate_professor + fac_professor + fac_yearsinhighed, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm3a <-
  df_temp %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm4a <-
  df_temp %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm5a <-
  df_temp %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac * reservation_stu + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

knitreg(list(lm1a, lm2a, lm3a, lm4a, lm5a), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = FALSE, dcolumn = TRUE, booktabs = TRUE, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F)
```

\newpage

### Course based

```{r}
df_temp_controls <-
  df_grades %>% 
  inner_join(
    readxl::read_xlsx(here::here("data/follow_on_courses_v2.xlsx")) %>%
      filter(semester_diff == 1) %>% 
      select(univcode, semester = semester_intro, course_name = course_name_intro) %>%
      drop_na(course_name) %>%
      distinct(), .
  ) %>% 
  select(stdid, course_name_intro = course_name, reservation_fac, fac_associate_professor, fac_professor, fac_yearsinhighed, fac_highest_degree_phd, fac_highest_degree_phd_in_prog, fac_degree_college_elite, fac_female) %>% 
  arrange(stdid, course_name_intro) %>% 
  distinct()

df_temp <-
  df_grades %>%
  inner_join(
    readxl::read_xlsx(here::here("data/follow_on_courses_v2.xlsx")) %>%
      filter(semester_diff == 1) %>%
      rename(semester = semester_followon, course_name = course_name_followon) %>%
      drop_na(course_name_intro) %>%
      distinct(), 
    ., 
    by = c("univcode", "course_name", "semester")
  ) %>% 
  select(-contains(c("fac_", "_fac"))) %>%
  inner_join(df_temp_controls, ., by = c("stdid", "course_name_intro")) %>%
  arrange(stdid, course_name) %>%
  relocate(stdid, course_rank, course_name) %>% 
  distinct()

df_temp2 <-
  df_temp %>% 
  drop_na(course_rank) %>%
  group_by(stdid, reservation_stu, department_id, course_name, course_rank, facid) %>% 
  summarise(
    reservation_fac = mean(reservation_fac, na.rm = T),
    fac_associate_professor = mean(fac_associate_professor, na.rm = T),
    fac_professor = mean(fac_professor, na.rm = T),
    fac_yearsinhighed = mean(fac_yearsinhighed, na.rm = T),
    fac_highest_degree_phd = mean(fac_highest_degree_phd, na.rm = T),
    fac_highest_degree_phd_in_prog = mean(fac_highest_degree_phd_in_prog, na.rm = T),
    fac_degree_college_elite = mean(fac_degree_college_elite, na.rm = T),
    fac_female = mean(fac_female, na.rm = T),
  ) %>% 
  ungroup()
```

Dependent variable mean is 51.67 and SD is 27.86. All models include course fixed effects and student fixed effects. SEs clustered at faculty level. Faculty treatment and controls are _not_ multiplied by 10 here.

```{r, results='asis'}
lm1a <-
  df_temp2 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm2a <-
  df_temp2 %>% 
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac + fac_associate_professor + fac_professor + fac_yearsinhighed, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm3a <-
  df_temp2 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm4a <-
  df_temp2 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

lm5a <-
  df_temp2 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(course_rank ~ reservation_fac * reservation_stu + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., fixed_effects = ~ stdid + fe_var, se_type = "stata", clusters = facid)

knitreg(list(lm1a, lm2a, lm3a, lm4a, lm5a), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = FALSE, dcolumn = TRUE, booktabs = TRUE, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F)
```


```{r, eval=FALSE}
knitreg(list(a, b, c, d), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = FALSE, dcolumn = TRUE, booktabs = TRUE, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, custom.model.names = c("Follow-on semester", "Follow-on course", "Math", "Physics"))
```

\newpage

# Year 3-4 Cohort

```{r}
df_year34 <-
  read_dta(here::here("data", "all_appended.dta")) %>%
  filter(tag < 2) %>% 
  distinct(stdid, course_name, facid, .keep_all = T) %>% 
  mutate(department_id = str_sub(stdid, 1, 7)) %>%
  left_join(read_dta(here::here("data/bfac_controls_ind.dta")), by = "facid") %>% 
  left_join(df_stu %>% select(stdid, reservation, b_i_jeemain_score, took_jee, b_math_g3_score, b_physics_g3_score, b_ct_score, b_ql_score, e_ct_score, e_ql_score, b_rr_score, e_rr_score, e_ee_short_score, e_ee_long_score, e_attend_grad_school, e_college_satisfied, e_dropped_out, e_switchmajor, expgrad4, e_math_attend = e_univtimeuse_1, e_physics_attend = e_univtimeuse_4, e_hot_attend = e_univexpr_55, e_talkprof_research, e_workprof_research, e_received_tutoring, e_growth_mindset_z), by = "stdid") %>%
  left_join(read_dta(here::here("data/controls.dta")), by = "stdid") %>%
  filter(department_id %in% department_ids) %>% 
  mutate(
    father_college = if_else(father_ed_ind > 3 & !is.na(father_ed_ind), 1L, 0L),
    father_college = if_else(is.na(father_ed_ind), NA_integer_, father_college),
    mother_college = if_else(mother_ed_ind > 3 & !is.na(mother_ed_ind), 1L, 0L),
    mother_college = if_else(is.na(mother_ed_ind), NA_integer_, mother_college),
    b_ct_score = scale(b_ct_score) %>% as.vector,
    b_ql_score = scale(b_ql_score) %>% as.vector,
    b_math_g3_score = scale(b_math_g3_score) %>% as.vector,
    b_physics_g3_score = scale(b_physics_g3_score) %>% as.vector,
    bfac_degree_college_elite = bfac_degree_univ_elite
  ) %>%
  relocate(department_id, course_name, stdid) %>% 
  rename(reservation_stu = reservation) %>% 
  left_join(read_dta(here::here("data/cs_test_scores.dta")), by = "stdid")
```


```{r, eval=F}
df_grades %>% 
  mutate(
    course = str_c(department_id, course_name),
    classroom = str_c(department_id, course_name, facid),
  ) %>% 
  count(classroom)

df_year34 %>%
  mutate(
    course = str_c(department_id, course_name),
    classroom = str_c(department_id, course_name, facid),
  ) %>% 
  count(classroom)
```

## Balance Checks

```{r, results='asis', eval=FALSE}
# stu regressions
lm1b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(female ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm2b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(reservation_stu ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm3b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(age ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm4b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(father_college ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm5b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(mother_college ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm6b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(b_i_jeemain_score ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm7b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(b_ct_score ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm8b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(b_ql_score ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm9b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(b_math_g3_score ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm10b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(b_physics_g3_score ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm11b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(took_jee ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

knitreg(list(lm1b, lm2b, lm3b, lm4b, lm5b), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, custom.coef.map = list("bfac_reservation" = "Res Faculty"), custom.model.names = c("Female", "Reservation", "Age", "Father college", "Mother college"))

knitreg(list(lm11b, lm6b, lm7b, lm8b, lm9b, lm10b), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, custom.coef.map = list("bfac_reservation" = "Res Faculty"), custom.model.names = c("Took JEE", "JEE score", "CT score", "QL score", "Math score", "Physics score"))

# df_year34 %>% 
#   skim(reservation_stu, female, age, father_college, mother_college, b_math_g3_score, b_physics_g3_score, b_i_jeemain_score, took_jee) %>% 
#   as_tibble() %>%
#   select(skim_variable, numeric.mean, numeric.sd) %>% 
#   mutate_if(is.numeric, ~ round(., 2))
```

```{r, results='asis', eval=FALSE}
# fac regressions
lm1b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_assistant_professor ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm2b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_associate_professor ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm3b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_professor ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm4b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_yearsinhighed ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm5b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_highest_degree_masters ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm6b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_highest_degree_phd ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm7b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_highest_degree_phd_in_prog ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm8b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_degree_college_elite ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

lm9b <-
  df_year34 %>%
  mutate(fe_var = str_c(department_id, course_name, sep = "_")) %>%
  lm_robust(bfac_female ~ bfac_reservation , data = ., fixed_effects = ~ fe_var, se_type = "stata", clusters = facid)

knitreg(list(lm1b, lm2b, lm3b, lm4b, lm5b, lm6b, lm7b, lm8b, lm9b), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, custom.coef.map = list("bfac_reservation" = "Res Faculty"))

# df_year34 %>%
#   skim(bfac_reservation, bfac_assistant_professor, bfac_associate_professor, bfac_professor, bfac_yearsinhighed, bfac_highest_degree_masters, bfac_highest_degree_phd, bfac_highest_degree_phd_in_prog, bfac_degree_college_elite, bfac_female) %>%
#   as_tibble() %>%
#   select(skim_variable, numeric.mean, numeric.sd) %>%
#   mutate_if(is.numeric, ~ round(., 2))
```


```{=latex}
\begin{table}[H]
  \centering
  \begin{tabular}{@{}lllllll@{}}
    \toprule
    \multicolumn{1}{c}{}  &  & \multicolumn{5}{c}{Panel A: Faculty}  \\ \cmidrule(l){3-7}
                                      &           &               &             &           &                             &             \\
    \textbf{Faculty characteristics}  & \textbf{} & \textbf{Mean} & \textbf{SD} & \textbf{} & \textbf{Res-NonRes faculty} & \textbf{SE} \\
                                      &           &               &             &           &                             &             \\
    Reservation status                &           & 0.38          & 0.48        &           & 1.000                       &             \\
    Assistant Professor               &           & 0.72          & 0.45        &           & 0.095**                     & 0.048       \\
    Associate Professor               &           & 0.16          & 0.37        &           & -0.044                      & 0.040       \\
    Professor                         &           & 0.08          & 0.27        &           & -0.034                      & 0.034       \\
    Experience in years               &           & 10.05         & 6.84        &           & -1.035                      & 0.684       \\
    Highest degree is Masters         &           & 0.54          & 0.50        &           & 0.005                       & 0.053       \\
    Highest degree is PhD             &           & 0.25          & 0.43        &           & -0.054                      & 0.042       \\
    Highest degree is PhD in progress &           & 0.19          & 0.40        &           &  0.032                      & 0.048       \\
    Degree college elite              &           & 0.30          & 0.46        &           &  0.083*                     & 0.045       \\
    Female                            &           & 0.33          & 0.47        &           & -0.036                      & 0.053       \\
                                      &           &               &             &           &                             &             \\ \cmidrule(l){3-7}
    &  & \multicolumn{5}{c}{Panel B: Students} \\ \cmidrule(l){3-7}
                                      &           &               &             &           &                             &             \\
    \textbf{Student characteristics}  & \textbf{} & \textbf{Mean} & \textbf{SD} & \textbf{} & \textbf{Res-NonRes faculty} & \textbf{SE} \\
                                      &           &               &             &           &                             &             \\
    Reservation status                &           & 0.49          & 0.50        &           & -0.003                      & 0.009       \\
    Female                            &           & 0.45          & 0.50        &           & -0.004                      & 0.008       \\
    Age                               &           & 19.76         & 0.99        &           & 0.011                       & 0.013       \\
    Father college                    &           & 0.56          & 0.50        &           & 0.003                       & 0.007       \\
    Mother college                    &           & 0.39          & 0.49        &           & -0.002                      & 0.006       \\ 
    Baseline Math score               &           & 0.00          & 1.00        &           & -0.007                      & 0.019       \\
    Baseline Physics score            &           & 0.00          & 1.00        &           & -0.014                      & 0.015       \\
    JEE Main score                    &           & 79.74         & 38.53       &           & -0.662                      & 0.587       \\
    Took JEE Main                     &           & 0.66          & 0.48        &           & 0.001                       & 0.009       \\ \bottomrule
  \end{tabular}
\end{table}
```



\newpage


## College satisfaction

The dependent variable is college satisfaction (0/1). Mean is 0.72. All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_year34 %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_college_satisfied, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(bfac_reservation, na.rm = T) * 10,
    fac_associate_professor = mean(bfac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(bfac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(bfac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(bfac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(bfac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(bfac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(bfac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_college_satisfied ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage

## Plans for grad school

The dependent variable is plans for grad school (0/1). Mean is 0.51. All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_year34 %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_attend_grad_school, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(bfac_reservation, na.rm = T) * 10,
    fac_associate_professor = mean(bfac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(bfac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(bfac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(bfac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(bfac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(bfac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(bfac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()


lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_attend_grad_school ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

## Expected graduation

The dependent variable is expected graduation (0/1). Mean is 0.9885. All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

### Crosstabs of control variables with dropout status

```{r}
df_temp <-
  df_year34 %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, expgrad4, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(bfac_reservation, na.rm = T) * 10,
    fac_associate_professor = mean(bfac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(bfac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(bfac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(bfac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(bfac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(bfac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(bfac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()
```

```{r}
df_temp %>% tabyl(reservation_stu, expgrad4, show_na = F) %>% knitr::kable(booktabs = T)
```

```{r}
df_temp %>% tabyl(female, expgrad4, show_na = F) %>% knitr::kable(booktabs = T)
```

```{r}
df_temp %>% tabyl(father_college, expgrad4, show_na = F) %>% knitr::kable(booktabs = T)
```

```{r}
df_temp %>% tabyl(mother_college, expgrad4, show_na = F) %>% knitr::kable(booktabs = T)
```


\newpage

### Probit model with marginal effects

```{r, results='asis'}
lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(expgrad4 ~ reservation_fac + department_id, data = ., robust = T)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(expgrad4 ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + department_id, data = ., robust = T)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(expgrad4 ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female + department_id, data = ., robust = T)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  mfx::probitmfx(expgrad4 ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female + department_id, data = ., robust = T)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 5, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)|(department_id)")
```


\newpage

## Switch major

The dependent variable is switching major (0/1). Mean is 0.00046. All models are linear and include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_year34 %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_switchmajor, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(bfac_reservation, na.rm = T) * 10,
    fac_associate_professor = mean(bfac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(bfac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(bfac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(bfac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(bfac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(bfac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(bfac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_switchmajor ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage


## Closed or open mindset

The dependent variable growth mindset is created by applying the Anderson index to 3 survey items on intelligence beliefs across the national sample. This variable is then turned into a z-score before use in below regression models. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

```{r, results='asis'}
df_temp <-
  df_year34 %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  group_by(stdid, e_growth_mindset_z, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(bfac_reservation, na.rm = T) * 10,
    fac_associate_professor = mean(bfac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(bfac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(bfac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(bfac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(bfac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(bfac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(bfac_female, na.rm = T) * 10,
  ) %>% 
  ungroup()

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_growth_mindset_z ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

## Test Scores

The dependent variables are standardized test scores (capped between -3 and +3). All models include department fixed effects. Faculty treatment and controls aggregated to student level (range 0-1), and multiplied by 10.

### Electrical Engineering Test

```{r, results='asis'}
df_temp <-
  df_year34 %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  drop_na(e_ee_short_score) %>%
  group_by(stdid, e_ee_short_score, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(bfac_reservation, na.rm = T) * 10,
    fac_associate_professor = mean(bfac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(bfac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(bfac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(bfac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(bfac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(bfac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(bfac_female, na.rm = T) * 10,
  ) %>%
  ungroup() %>% 
  mutate(
    e_ee_short_score = scale(e_ee_short_score) %>% as.vector,
    # limits
    e_ee_short_score = if_else(e_ee_short_score > 3, 3, e_ee_short_score),
    e_ee_short_score = if_else(e_ee_short_score < -3, -3, e_ee_short_score)  
  )

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_ee_short_score ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_ee_short_score ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_ee_short_score ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_ee_short_score ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```

\newpage

EE short test z-score distribution:

```{r}
df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  ggplot(aes(e_ee_short_score)) +
  geom_histogram(bins = 15, alpha = 0.85) +
  theme_minimal()
```

\newpage

### Computer Science Test

```{r, results='asis'}
df_temp <-
  df_year34 %>%
  mutate(
    miss_age = if_else(is.na(age), 1L, 0L),
    age = if_else(is.na(age), 0, age),
  ) %>%
  drop_na(e_cs_score) %>%
  group_by(stdid, e_cs_score, reservation_stu, female, father_college, mother_college, age, miss_age, department_id) %>% 
  summarise(
    reservation_fac = mean(bfac_reservation, na.rm = T) * 10,
    fac_associate_professor = mean(bfac_associate_professor, na.rm = T) * 10,
    fac_professor = mean(bfac_professor, na.rm = T) * 10,
    fac_yearsinhighed = mean(bfac_yearsinhighed, na.rm = T) * 10,
    fac_highest_degree_phd = mean(bfac_highest_degree_phd, na.rm = T) * 10,
    fac_highest_degree_phd_in_prog = mean(bfac_highest_degree_phd_in_prog, na.rm = T) * 10,
    fac_degree_college_elite = mean(bfac_degree_college_elite, na.rm = T) * 10,
    fac_female = mean(bfac_female, na.rm = T) * 10,
  ) %>%
  ungroup() %>% 
  mutate(
    e_cs_score = scale(e_cs_score) %>% as.vector,
   # limits
    e_cs_score = if_else(e_cs_score > 3, 3, e_cs_score),
    e_cs_score = if_else(e_cs_score < -3, -3, e_cs_score) 
  )

lm1 <-
  df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_cs_score ~ reservation_fac, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm2 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_cs_score ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm3 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_cs_score ~ reservation_fac + reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

lm4 <-
  df_temp %>% 
  drop_na(female, father_college, mother_college) %>%
  lm_robust(e_cs_score ~ reservation_fac * reservation_stu + female + age + miss_age + father_college + mother_college + fac_associate_professor + fac_professor + fac_yearsinhighed + fac_highest_degree_phd + fac_highest_degree_phd_in_prog + fac_degree_college_elite + fac_female, data = ., se_type = "stata", fixed_effects = ~ department_id)

knitreg(list(lm1, lm2, lm3, lm4), custom.note = "%stars", stars = c(0.01, 0.05, 0.1), include.ci = F, dcolumn = T, booktabs = T, float.pos = "H", caption = "", digits = 3, include.nclust = F, include.rsquared = F, include.adjrs = F, include.rmse = F, omit.coef = "(miss_age)|(Intercept)")
```


\newpage

CS Test z-score distribution:

```{r}
df_temp %>%
  drop_na(female, father_college, mother_college) %>%
  ggplot(aes(e_cs_score)) +
  geom_histogram(bins = 15, alpha = 0.85) +
  theme_minimal()
```

